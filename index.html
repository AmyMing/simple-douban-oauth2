<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Simple-douban-oauth2 : A simple php douban oauth2 client" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Simple-douban-oauth2</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/zither/simple-douban-oauth2">View on GitHub</a>

          <h1 id="project_title">Simple-douban-oauth2</h1>
          <h2 id="project_tagline">A simple php douban oauth2 client</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/zither/simple-douban-oauth2/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/zither/simple-douban-oauth2/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>About</h3>
        <p>Simple douban oauth2是一个非常简洁的豆瓣PHP Oauth2 SDK，为小型PHP网站提供了简单的豆瓣Oauth2认证及豆瓣各类Api调用接口。目前还有很多api接口没有经过测试，我会尽快完成测试，并逐步完善PHP客户端文档。</p>

        <h3>Status</h3>
        <p>目前支持的豆瓣Api如下：</p>
        <pre><code>
        - 图书 Book
        - 电影 Movie （未测试）
        - 音乐 Music （未测试）
        - 同城 Event （未测试）
        - 广播 Miniblog 
        - 用户 User
        - 豆邮 Doumail （未测试）
        - 日记 Note （未测试）
        - 相册 Photo （未测试）
        - 线上活动 Online （未测试）
        - 论坛 discussion （未测试）
        - 回复 comment （未测试）
        </code></pre>

        <h3>Usage</h3>
        <p>这里提供了一个<a href="https://github.com/zither/simple-douban-oauth2/blob/master/example.php">使用Simple douban oauth2来发送图片广播</a>的例子。</p>

        <pre><code>/**
 * @file example.php
 * @brief Simple_douban_oauth2调用实例，内容为使用POST请求发表豆瓣广播。
 * @author JonChou <ilorn.mc@gmail.com>
 * @date 2012-12-03
 */

// 载入豆瓣Oauth类
require 'DoubanOauth.php';

/* ------------实例化Oauth2--------------- */

// 豆瓣应用public key
$clientId = '037c0301d3b81d570a7409057b285805';
// 豆瓣应用secret key
$secret = 'c2c9c36981ef49c6';
// 用户授权后的回调链接
$callback = 'http://localhost/example.php';
// 设置应用需要的权限，Oauth类默认设置为douban_basic_common
// 我们要发送豆瓣广播，就必须申请shuo_basic_w权限
$scope ='douban_basic_common,shuo_basic_r,shuo_basic_w';
// 生成一个豆瓣Oauth类实例
$douban = new DoubanOauth($clientId, $secret, $callback, $scope);


/* ------------请求用户授权--------------- */

// 如果没有requestToken，跳转到用户授权页面
if ( ! isset($_GET['code'])) {
    $douban->getAuthorizeCode();
    exit;
}
// 设置authorizeCode
$douban->setAuthorizeCode($_GET['code']);
// 通过requestToken获取accessToken，至此完成用户授权
$douban->getAccessToken();


/* ------------发送图片广播--------------- */

// 通过豆瓣API发送一条带图片的豆瓣广播
// 我看到豆瓣API小组里很多朋友都卡在了发送图片广播上，那是因为没有设置正确的Content-Type。
// 在PHP中通过curl上传图片需使用类似“@/home/chou/images/123.png;type=image/png”格式
// 并且需在图片路径后指定正确的图片类型，如果没有指定类型会返回“不支持的图片类型错误”。
// 那是因为没有指定图片类型时，上传的文件类型默认为“application/octet-stream”。
$data = array(
            'source' => $clientId, 
            'text' =>'继续修改，继续测试。', 
            'image' => '@/home/chou/downloads/123.jpg;type=image/jpeg'
            );
// 发表广播需要用到豆瓣广播API，注册一个豆瓣广播API实例
$miniblog = $douban->apiRegister('Miniblog');
// 选择发表我说
$miniblog->addMiniblog();
// 使用豆瓣Oauth类向我说API发送请求，并获取返回结果，需授权api必须设置第三参数为true
// 当第三个参数为true时会在header中发送accessToken，默认不发送。
$result = $douban->makeRequest($miniblog, $data, true);
// 打印结果(Json格式)
var_dump($result);
        </code></pre>

        <p>Simple douban oauth2的所有API类都保存在<strong>api</strong>文件夹中，你可以非常方便的按照需求修改各个接口。</p>

        <p>一个简单的豆瓣图书Api类作为示例：</p>

        <pre><code>class Book extends Base {

    // 初始化clientId，在uri后面添加apikey可以拥有更宽裕的请求次数
    public function __construct($clientId)
    {
        $this->clientId = $clientId;
    }

    // 无需授权的GET请求示例
    public function getBook($id)
    {
        // 没有添加apikey，单IP每分钟只能请求10次
        $this->uri = '/v2/book/'.$id;
        // 添加apikey之后，单IP每分钟可以请求40次
        // $this->uri = '/v2/book/'.$id.'?apikey='.$this->clientId;
        $this->type = 'GET';
        return $this;
    }

    // 需要授权的POST请求示例
    public function addReview()
    {
        $this->uri = "/v2/book/reviews";
        // API默认请求设置为GET，因此这里需说明请求类型
        $this->type = 'POST';
        return $this;     
    }        
}
        </code></pre>



        
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Simple-douban-oauth2 maintained by <a href="https://github.com/zither">zither</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
